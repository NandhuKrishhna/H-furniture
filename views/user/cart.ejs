<style>

  .cart {
    margin-top: 20px;
    position: relative;
    /* right: -95px; */
    left: 70px;

  }

  .form-control {
    border-radius: 0;

  }

  .form-control:focus {
    box-shadow: none;
    border-color: #757575;
  }

  .apply {
    border-radius: 0;

  }

  .cart-item img {
    max-width: 100px;
    margin-right: 10px;
  }

  .cart-summary {
    background: #f9f9f9;
    border-radius: 2px;
    padding: 20px;
    border: 0.3px solid #dcdcdc;
  }

  .total-amount {
    font-size: 24px;
    font-weight: bold;
    color: #000;
  }


  .cart {
    margin-top: 20px;
    position: relative;
    /* right: -95px; */
    left: 70px;

  }

  .form-control {
    border-radius: 0;

  }

  .form-control:focus {
    box-shadow: none;
    border-color: #757575;
  }

  .apply {
    border-radius: 0;
  }
.container{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}
</style>
<div class="container my-5">
  <div class="row">
    <div class="col-md-8">
      <h2>Shopping Cart</h2>
      <% if (cart && cart.products && cart.products.length> 0) { %>
        <% cart.products.forEach(product=> { %>
          <div class="cart-item d-flex align-items-center my-4 p-3 border">
            <div class="d-flex flex-column align-items-center">
              <img src="/<%= product.image %>" alt="Product Image" class="img-fluid" style="width: 100px;">
              <button class="btn btn-link text-danger mt-2 remove-item" data-product-id="<%= product.productId %>">
                <i class="fa-solid fa-trash-can"></i> Remove
              </button>
            </div>
            <div class="ml-3">
              <h5>
                <%= product.productName %>
              </h5>
              <p>Expected Dispatch Date: <span style="color: green;">Sep 09, 2024</span></p>
              <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary btn-sm decrement-quantity"
                  data-product-id="<%= product.productId %>">-</button>
                <input type="text" class="form-control text-center mx-2 quantity-input" value="<%= product.quantity %>"
                  style="width: 50px;" id="quantity-<%= product.productId %>">
                <button class="btn btn-outline-secondary btn-sm increment-quantity"
                  data-product-id="<%= product.productId %>">+</button>
              </div>
            </div>
            <div class="ml-auto text-right">
              <h4 class="text-dark product-price" id="price-<%= product.productId %>">₹<%= product.price.toFixed(2) %>
              </h4>
            </div>
          </div>
          <% }); %>
            <% } else { %>
              <p>Your cart is empty.</p>
              <a href="/user/products" class="btn btn-dark" style="border-radius:0;">Shop Now</a>
              <% } %>
    </div>
    <!-- Cart Summary Partials -->
    <div class="col-md-4 cart">
      <div class="cart-summary">
        <h5>Apply Coupon Code</h5><br>
        <div class="input-group mb-3">
          <input type="text" id="couponCode" class="form-control" placeholder="Enter Coupon Code" required>
          <div class="input-group-append">
            <button id="applyCoupon" class="btn btn-dark">Apply</button>
          </div>
        </div>
        <div id="appliedCouponMessage" class="text-success mb-3" style="display: none;">
          Applied Coupon: <span id="appliedCouponCode"></span>
          <span id="removeCoupon" style="cursor: pointer; color: red; margin-left: 10px;">&times;</span>
        </div>
        <br>
        <h5>Cart Summary</h5>
        <ul class="list-unstyled">
          <li class="d-flex justify-content-between">
            <span>SubTotal</span>
            <span>₹<span id="subtotalAmount"><%= cart && cart.totalAmount ? cart.totalAmount.toFixed(2) : '0.00' %></span></span>
          </li>
        </ul>
        <p>Packing Charges: <span class="float-right">₹0</span></p>
        <% if (cart && cart.products.length > 0) { %>
          <p>Shipping & Handling: <span class="float-right"><del>₹4,000</del> FREE</span></p>
        <% } else { %>
          <p>Shipping & Handling: <span class="float-right"><del>₹0</del></span></p>
        <% } %>
        <p>Negotiated Discount: <span class="float-right" id="negotiatedDiscount">₹0</span></p>
        <div class="d-flex justify-content-between">
          <span>Total Amount</span>
          <span id="totalAmount" class="total-amount">₹<%= cart && cart.finalAmount ? cart.finalAmount.toFixed(2) : '0.00' %></span>
        </div>
        <button class="btn btn-dark btn-block mt-3"
          onclick="proceedToCheckout(`<%= hadAddress ? 'true' : 'false' %>`, '<%= userInfo._id %>')"
          <%= cart.products.length === 0 ? 'disabled' : '' %>>
          Proceed to Checkout
        </button>
        <small class="text-muted d-block mt-2">By continuing, you agree to Habus's Terms of Use and Privacy Policy.</small>
      </div>
    </div>
    
    <script>
      document.querySelectorAll('.increment-quantity').forEach(button => {
        button.addEventListener('click', () => {
          const productId = button.dataset.productId;
          updateQuantity(productId, 1);
        });
      });
    
      document.querySelectorAll('.decrement-quantity').forEach(button => {
        button.addEventListener('click', () => {
          const productId = button.dataset.productId;
          updateQuantity(productId, -1);
        });
      });
    
      async function updateQuantity(productId, change) {
        const quantityInput = document.getElementById(`quantity-${productId}`);
        let newQuantity = parseInt(quantityInput.value) + change;
        if (newQuantity < 1) newQuantity = 1;
        quantityInput.value = newQuantity;
    
        try {
          const response = await fetch(`/user/cart/${productId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ quantity: newQuantity })
          });
    
          if (response.ok) {
            const data = await response.json();
            document.getElementById(`price-${productId}`).innerText = `₹${data.updatedProductTotalPrice.toFixed(2)}`;
            document.querySelector('#subtotalAmount').innerText = `₹${data.updatedTotalAmount.toFixed(2)}`;
            document.querySelector('#totalAmount').innerText = `₹${data.finalAmount.toFixed(2)}`;
          } else {
            console.error('Failed to update quantity');
          }
        } catch (error) {
          console.error('Error:', error);
        }
      }
    
      document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', () => {
          const productId = button.dataset.productId;
    
          console.log(`Remove item with ID: ${productId}`);
    
          $.ajax({
            url: `/user/cart/${productId}`,
            type: 'DELETE',
            success: function (response) {
              if (response.success) {
                location.reload();
                document.getElementById(`cart-item-${productId}`).remove();
                document.querySelector('#subtotalAmount').innerText = `₹${response.updatedTotalAmount.toFixed(2)}`;
                document.querySelector('#totalAmount').innerText = `₹${response.finalAmount.toFixed(2)}`;
    
                console.log('Product removed successfully.');
              } else {
                console.error('Failed to remove product from cart:', response.message || 'No message provided');
              }
            },
            error: function (xhr, status, error) {
              console.error('An error occurred:', status, error);
              console.error('Response:', xhr.responseText);
            }
          });
        });
      });
    
      $(document).ready(function () {
        $('#applyCoupon').on('click', function () {
          var couponCode = $('#couponCode').val().trim();
          var userId = "<%= userId %>";
    
          if (!couponCode) {
            alert('Please enter a coupon code.');
            return;
          }
    
          $.ajax({
            url: '/user/cart/' + userId + '/apply-coupon',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ couponCode: couponCode }),
            success: function (response) {
              if (response.success) {
                $('#totalAmount').text('₹' + response.finalAmount.toFixed(2));
                $('#negotiatedDiscount').text('₹' + response.discountValue.toFixed(2));
                $('#appliedCouponMessage').show();
                $('#appliedCouponCode').text(couponCode);
              } else {
                alert(response.message);
              }
            },
            error: function (xhr, status, error) {
              console.error('Error applying coupon:', error);
              alert('An error occurred while applying the coupon. Please try again.');
            }
          });
        });
    
        $('#removeCoupon').on('click', function () {
          var userId = "<%= userId %>";
          $.ajax({
            url: '/user/cart/' + userId + '/remove-coupon',
            method: 'POST',
            contentType: 'application/json',
            success: function (response) {
              if (response.success) {
                $('#appliedCouponMessage').hide();
                $('#couponCode').val('');
                $('#totalAmount').text('₹' + response.totalAmount.toFixed(2));
                $('#negotiatedDiscount').text('₹0');
              } else {
                alert(response.message);
              }
            },
            error: function (xhr, status, error) {
              console.error('Error removing coupon:', error);
              alert('An error occurred while removing the coupon. Please try again.');
            }
          });
        });
      });

    


  function proceedToCheckout(hadAddress, userId) {
    if (hadAddress === 'true') {
      window.location.href = `/user/checkout_address_details/${userId}`;
    } else {
      window.location.href = `/user/add_checkout_address/${userId}`;
    }
  }




</script>





