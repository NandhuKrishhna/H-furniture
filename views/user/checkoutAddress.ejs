<style>
  .address-card {
    border: 1px solid #ddd;
    padding: 15px;
    margin-bottom: 15px;
  }
  .cart-item img {
    max-width: 100px;
    margin-right: 10px;
  }

  .cart-summary {
    background: #f9f9f9;
    border-radius: 2px;
    padding: 20px;
    border: 0.3px solid #dcdcdc;
  }

  .total-amount {
    font-size: 24px;
    font-weight: bold;
    color: #000;
  }

  .total-savings {
    color: green;
    font-weight: bold;
  }

  .cart {
    margin-top: 20px;
    position: relative;
    /* right: -95px; */
    left: 70px;

  }

  .form-control {
    border-radius: 0;

  }

  .form-control:focus {
    box-shadow: none;
    border-color: #757575;
  }

  .apply {
    border-radius: 0;

  }

  .cart-item img {
    max-width: 100px;
    margin-right: 10px;
  }

  .cart-summary {
    background: #f9f9f9;
    border-radius: 2px;
    padding: 20px;
    border: 0.3px solid #dcdcdc;
  }

  .total-amount {
    font-size: 24px;
    font-weight: bold;
    color: #000;
  }

  .total-savings {
    color: green;
    font-weight: bold;
  }

  .cart {
    margin-top: 20px;
    position: relative;
    /* right: -95px; */
    left: 70px;

  }

  .form-control {
    border-radius: 0;

  }

  .form-control:focus {
    box-shadow: none;
    border-color: #757575;
  }

  .apply {
    border-radius: 0;
  }
</style>

<div class="container">
  <div class="row mt-4">
    <!-- Main Content Column -->
    <div class="col-lg-8">
      <!-- Address and Shipping Methods Section -->
      <h2>Select Delivery Address</h2>
      <form id="addressForm" action="/user/checkout_address_details/<%= userId %> " method="POST">
        <% if (address && address.length> 0) { %>
          <% address.forEach(function(addr) { %>
            <div class="address-card">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="selectedAddress" id="address<%= addr._id %>"
                  value="<%= addr._id %>" <%=addr.isPrimary ? 'checked' : '' %>>
                <label class="form-check-label" for="address<%= addr._id %>">
                  <strong>
                    <%= addr.firstName %>
                      <%= addr.lastName %>
                  </strong><br>
                  <%= addr.homeAddress %>, <%= addr.street %>, <%= addr.city %>, <%= addr.state %>, <%= addr.country %>,
                            <%= addr.pincode %><br>
                              Mob: <%= Array.isArray(addr.phone) ? addr.phone.join(", ") : addr.phone %>
          </label>
        </div>
        <div class=" mt-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm delete-address"
                                  data-address-id="<%= addr._id %>">Remove</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm edit-address"
                                  data-address-id="<%= addr._id %>">Edit</button>
              </div>
            </div>
            <% }) %>
              <% } %>
                <button type="submit" class="btn btn-dark mt-3">Confirm Address</button>
      </form>
      <a href="/user/add_address" class="btn btn-dark mt-3"> Add New Address</a><br><br>
      <h3>Shipping Methods</h3>
      <div class="address-card">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="shippingMethod" id="homeDelivery" checked>
          <label class="form-check-label" for="homeDelivery">
            Home Delivery
          </label>
        </div>
      </div>
      <h3>Billing Information</h3>
      <div class="address-card">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="billingAddress" id="sameAddress" checked>
          <label class="form-check-label" for="sameAddress">
            Use same address for delivery and billing
          </label>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="billingAddress" id="differentAddress">
          <label class="form-check-label" for="differentAddress">
            Use different billing address
          </label>
        </div>
      </div>
    </div>

    <!-- Cart Summary Partials -->
    <div class="col-md-4 cart">
      <div class="cart-summary">
        <h5>Apply Coupon Code</h5><br>
        <div class="input-group mb-3">
          <input type="text" id="couponCode" class="form-control" placeholder="Enter Coupon Code" required>
          <div class="input-group-append">
            <button id="applyCoupon" class="btn btn-dark">Apply</button>
          </div>
        </div>
        <div id="appliedCouponMessage" class="text-success mb-3" style="display: none;">
          Applied Coupon: <span id="appliedCouponCode"></span>
          <span id="removeCoupon" style="cursor: pointer; color: red; margin-left: 10px;">&times;</span>
        </div>
        <br>
        <h5>Cart Summary</h5>
        <ul class="list-unstyled">
          <li class="d-flex justify-content-between">
            <span>SubTotal</span>
            <span>₹<span id="subtotalAmount"><%= cart && cart.totalAmount ? cart.totalAmount.toFixed(2) : '0.00' %></span></span>
          </li>
        </ul>
        <p>Packing Charges: <span class="float-right">₹0</span></p>
        <% if (cart && cart.products.length> 0) { %>
          <p>Shipping & Handling: <span class="float-right"><del>₹4,000</del> FREE</span></p>
          <% } else { %>
            <p>Shipping & Handling: <span class="float-right"><del>₹0</del></span></p>
            <% } %>
              <p>Negotiated Discount: <span class="float-right" id="negotiatedDiscount">₹0</span></p>
              <div class="d-flex justify-content-between">
                <span>Total Amount</span>
                <span id="totalAmount" class="total-amount">₹<%= cart && cart.finalAmount ? cart.finalAmount.toFixed(2) : '0.00' %></span>
              </div>
              <button class="continue-btn btn btn-dark btn-block mt-3" data-user-id="<%= userId %>">Continue</button>
              <small class="text-muted d-block mt-2">By continuing, you agree to Habus's Terms of Use and Privacy
                Policy.</small>
      </div>
    </div>
  </div>
</div>


<script>
  $(document).ready(function () {
        $('#applyCoupon').on('click', function () {
          var couponCode = $('#couponCode').val().trim();
          var userId = "<%= userId %>";
    
          if (!couponCode) {
            alert('Please enter a coupon code.');
            return;
          }
    
          $.ajax({
            url: '/user/cart/' + userId + '/apply-coupon',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ couponCode: couponCode }),
            success: function (response) {
              if (response.success) {
                $('#totalAmount').text('₹' + response.finalAmount.toFixed(2));
                $('#negotiatedDiscount').text('₹' + response.discountValue.toFixed(2));
                $('#appliedCouponMessage').show();
                $('#appliedCouponCode').text(couponCode);
              } else {
                alert(response.message);
              }
            },
            error: function (xhr, status, error) {
              console.error('Error applying coupon:', error);
              alert('An error occurred while applying the coupon. Please try again.');
            }
          });
        });
    
        $('#removeCoupon').on('click', function () {
          var userId = "<%= userId %>";
          $.ajax({
            url: '/user/cart/' + userId + '/remove-coupon',
            method: 'POST',
            contentType: 'application/json',
            success: function (response) {
              if (response.success) {
                $('#appliedCouponMessage').hide();
                $('#couponCode').val('');
                $('#totalAmount').text('₹' + response.totalAmount.toFixed(2));
                $('#negotiatedDiscount').text('₹0');
              } else {
                alert(response.message);
              }
            },
            error: function (xhr, status, error) {
              console.error('Error removing coupon:', error);
              alert('An error occurred while removing the coupon. Please try again.');
            }
          });
        });
      });
      
  $(document).ready(function () {
      $(".delete-address").click(function(){
          const addressId = $(this).data("address-id");
          $.ajax({
              url: `/user/delete_address/${addressId}`,
              method: "DELETE",
              success: function(response) {
                  if (response.success) {
                      window.location.reload();
                  } else {
                      alert(response.message);
                  }
              },
              error: function() {
                  alert("Error occurred while deleting the address");
              }
          });
      });
  });


$(document).ready(function () {
  $(".edit-address").click(function() {
      const addressId = $(this).data("address-id");
   
      window.location.href = `/user/edit_address/${addressId}`;
  });
});

$(document).ready(function () {
  $(".continue-btn").click(function() {
      const userId = $(this).data("user-id");
    
      window.location.href = `/user/payment_method/${userId}`;
  });
});




    </script>